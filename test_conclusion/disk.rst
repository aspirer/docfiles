
磁盘IO性能测试结论
==================


云主机实例存储QoS性能测试
-------------------------

.. note::
    表格中数据由fio测试工具得出

#. **测试1：验证实例存储QoS的效果**

    * 虚拟机间的I/O能力与分配给该虚拟机的实例存储大小基本成正比例关系

    * 宿主机的I/O能力限定在设置的bps和iops范围内

    * 与我们对实例存储QoS的设计目标相一致

    * 上述结论与我们对实例存储QoS的设计目标相一致

    * 上述结论根据表格1得出

    .. figure:: images/disk_table_1.png
        :align: center

#. **测试二：虚拟机I/O性能损耗测试**

    * 该环境上，虚拟化对I/O的损耗，顺序读大概损耗51%、顺序写大概损耗17.5%

    * 另一个影响就是cgroup，对虚拟机设置了cgroup 1000的weight值，然后测试了一下I/O，和没设置cgroup的性能数据差不多，也即是说cgroup对I/O性能影响较小

    * 上述结论与方应之前关于cgroup对I/O的测试 `<http://doc.hz.netease.com/display/cloud/Cgroup>`_ 也比较吻合

    * 上述结论根据表格2得出

    .. figure:: images/disk_table_2.png
        :align: center


#. **测试三：实例存储QoS性能完整测试**

    * 对比单个虚拟机和单独宿主机的fio测试的iops值，可以看出：该环境上单台虚拟机顺序读的虚拟化I/O损耗大概在59%，顺序写的虚拟化I/O损耗大概在42%。这个与“测试二”中的虚拟化损耗 51% 和17.5% 有一定差异。也即是说虚拟机的I/O性能与物理机上的实例存储磁盘性能有一定关联。磁盘性能不一样，虚拟化对I/O的损耗比例也不一样。（这个也好理解，假设虚拟化导致的I/O延迟时间固定，不同性能的磁盘因为该I/O延迟导致的性能损耗比例也会不同）因此，存储QoS能保证的是完全相同的两个环境下（包括宿主机配置、正在运行的虚拟机配置、I/O压力），相同规格的虚拟机的I/O性能一致。环境不一样，相同配置的虚拟机的I/O能力不能保证一致。

    * 从最后三组的多个虚拟机并发fio测试数据来看，三台虚拟机并发时的虚拟化I/O损耗为：顺序读损耗在64.2%，顺序写损耗在37%。二台虚拟机并发时的虚拟化I/O损耗为：顺序读损耗在65%，顺序写损耗在45.3%。也即虚拟化I/O损耗与虚拟机的数量也有一定的关系（这个应该就是io并发引起的性能变化）。

    * 理论上，虚拟机的I/O 能力可以按如下公式来计算：假设，实例存储设备的I/O上限能力为C，开启实例存储QoS时预留给宿主机的I/O能力上限为Chost，实际分配给宿主机的I/O能力为C0。实例存储设备总大小为V，宿主机上某台虚拟机的实例存储大小为V’ ，宿主机上正在运行的所有虚拟机的实例存储大小总和为Va，kvm虚拟化技术的I/O损耗率为α，则开启实例存储Qos后分配每台虚拟机的I/O能力为C’：

        .. figure:: images/disk_img_1.png
            :align: center

    * 如上图中所示公式可知：

        * 开启QoS下，宿主机和三台虚拟机并发fio测试的顺序读写数据（用iops来表示I/O能力）（注意 当bps限制为10MB/s时，相应的宿主机iops大概为300），有：
            * 顺序读， C = 3052， C0 =304，V=520G， Va=180G，  （α≈ 0.642）
            * 对于虚拟机Test_40G，191 = C’ ≈ (C –C0) * (1-α) *  V’/Va  = （3052 - 304）* （1-α）* 40/ 180  = 219
            * 对于虚拟机Test_60G，287= C’ ≈ (C –C0) * (1-α) *  V’/Va  = （3052 - 304）* （1-α）*60/ 180  = 328
            * 对于虚拟机Test_80G，383= C’ ≈ (C –C0) * (1-α) *  V’/Va  = （3052 - 304）* （1-α）*80/ 180  = 437
            * 顺序写，C = 2897， C0 =303，V=520G， Va=180G，  （α≈ 0.37）
            * 对于虚拟机Test_40G，322 = C’ ≈ (C –C0) * (1-α) *  V’/Va  = （2897- 303）* （1-α）* 40/ 180  = 363
            * 对于虚拟机Test_60G，456= C’ ≈ (C –C0) * (1-α) *  V’/Va  = （2897- 303）* （1-α）*60/ 180  = 545
            * 对于虚拟机Test_80G，606= C’ ≈ (C –C0) * (1-α) *  V’/Va  = （2897- 303）* （1-α）*80/ 180  = 726

        * 开启QoS下，宿主机和两台虚拟机并发fio测试的顺序读写数据，有：
            * 顺序读， C = 3052， C0 =305，V=520G， Va=100G，  （α≈ 0.65）
            * 对于虚拟机Test_40G，343 = C’ ≈ (C –C0) * (1-α) *  V’/Va  = （3052 - 305）* （1-α）* 40/ 100  = 385
            * 对于虚拟机Test_60G，502= C’ ≈ (C –C0) * (1-α) *  V’/Va  = （3052 - 305）* （1-α）*60/ 100  = 577
            *
            * 顺序写，C = 2897， C0 =290，V=520G， Va=100G，  （α≈ 0.453）
            * 对于虚拟机Test_40G，559 = C’ ≈ (C –C0) * (1-α) *  V’/Va  = （2897- 290）* （1-α）* 40/ 100  = 472
            * 对于虚拟机Test_60G，732= C’ ≈ (C –C0) * (1-α) *  V’/Va  = （2897- 290）* （1-α）* 60/ 100  = 709

        * 根据上述计算公式中，上述两组测试的实际结果与后面的计算结果有一定的误差（10%左右），原因在于虚拟化损耗是按照虚拟机并发时的测试结果来评估，但当宿主机和虚拟机一起并发测试时，宿主机的I/O操作增加了整体的io并发数，这个对I/O性能有一定的影响，也会进一步影响到虚拟化中的I/O损耗。但误差范围不会太大，从上述两组结果来看，大概在10%左右。（该处损耗率是一个估计值，在后续的测试四中，会通过两组完全相同的并发情况来进一步推导验证该计算公式。）

    * 另外，需要特别指出的是，I/O QoS发挥作用是在存在I/O资源竞争的时候，会按照分配给虚拟机的I/O能力（该能力与虚拟机的实例存储大小成正比例关系）来分配I/O时间。当I/O压力不大的情况下，则会尽可能地满足虚拟机的I/O需求。实际场景中，单台宿主机上的虚拟机同时出现大量I/O操作的几率应该不会很高。

#. **测试四：实例存储QoS性能验证**

    * 假设，实例存储设备的I/O上限能力为C，开启实例存储QoS时预留给宿主机的I/O能力上限为Chost，实际分配给宿主机的I/O能力为C0。实例存储设备总大小为V，宿主机上某台虚拟机的实例存储大小为V’ ，宿主机上正在运行的所有虚拟机的实例存储大小总和为Va，kvm虚拟化技术的I/O损耗率为α，则开启实例存储Qos后分配每台虚拟机的I/O能力为C’，理论上，虚拟机的I/O 能力可以按如下公式来计算：

        .. figure:: images/disk_img_1.png
            :align: center

    * 如上图中所示公式可知：

        * 开启QoS下，宿主机和三台虚拟机并发fio测试的顺序读写数据（用iops来表示I/O能力），有：
            * 顺序读， C = 3888， C0 =975，V=246G， Va=180G，
            * 对于虚拟机Test_40G，118 = C’ ≈ (C –C0) * (1-α) *  V’/Va  = （3888 - 975）* （1-α）* 40/ 180
            * 对于虚拟机Test_60G，187 = C’ ≈ (C –C0) * (1-α) *  V’/Va  = （3888 - 975）* （1-α）*60/ 180
            * 对于虚拟机Test_80G，235 = C’ ≈ (C –C0) * (1-α) *  V’/Va  = （3888 - 975）* （1-α）*80/ 180 ，
            * 据此推算出 宿主机与三台虚拟机并发情况下顺序读的虚拟化损耗率α= 0.814

            * 对于虚拟机Test_20G、Test_40G、Test_60G与Host的并发测试，
            * C = 3888， C0 =976，V=246G， Va=120G，代入上面推出的损耗率α= 0.814 ，有：
                * 对于虚拟机Test_20G，89 = C’ ≈ (C –C0) * (1-α) *  V’/Va  = （3888 - 976）* （1-α）* 20/ 120  = 90.2 （前面89为实际值，后面90.2为计算出的理论值）
                * 对于虚拟机Test_40G，180 = C’ ≈ (C –C0) * (1-α) *  V’/Va  = （3888 - 976）* （1-α）*40/ 120  = 180.5
                * 对于虚拟机Test_60G，268 = C’ ≈ (C –C0) * (1-α) *  V’/Va  = （3888 - 976）* （1-α）*60/ 120  = 270.8
                * 从该组数据的验证结果来看，相同数量的虚拟机与宿主机并发io的虚拟化损耗率保持恒定，也就是说可以根据该损耗率计算出同等并发情况下的虚拟机的I/O能力。

            * 顺序写，C = 156， C0 =48，V=246G， Va=180G，
            * 对于虚拟机Test_40G，22 = C’ ≈ (C –C0) * (1-α) *  V’/Va  = （156 - 48）* （1-α）* 40/ 180
            * 对于虚拟机Test_60G，27 = C’ ≈ (C –C0) * (1-α) *  V’/Va  = （156 - 48）* （1-α）*60/ 180
            * 对于虚拟机Test_80G，36 = C’ ≈ (C –C0) * (1-α) *  V’/Va  = （156 - 48）* （1-α）*80/ 180 ，
            * 据此推算出 宿主机与三台虚拟机并发情况下顺序写的虚拟化损耗率α= 0.2
            *
            * 对于虚拟机Test_20G、Test_40G、Test_60G与Host的并发测试，
            * C = 156， C0 =52，V=246G， Va=120G，代入上面推出的损耗率α= 0.2 ，有：
                * 对于虚拟机Test_20G，14 = C’ ≈ (C –C0) * (1-α) *  V’/Va  = （156 - 52）* （1-α）* 20/ 120  = 13.9
                * 对于虚拟机Test_40G，30 = C’ ≈ (C –C0) * (1-α) *  V’/Va  = （156 - 52）*（1-α）*40/ 120  = 27.7
                * 对于虚拟机Test_60G，42 = C’ ≈ (C –C0) * (1-α) *  V’/Va  = （156 - 52）*（1-α）*60/ 120  = 41.6
                * 从该组数据的验证结果来看，相同数量的虚拟机与宿主机并发io的虚拟化损耗率保持恒定，也就是说可以根据该损耗率计算出同等并发情况下的虚拟机的I/O能力。


        * 开启QoS下，宿主机和两台虚拟机并发fio测试的顺序读写数据，有：
            * 顺序读， C = 3888， C0 =976，V=246G， Va=100G，
            * 对于虚拟机Test_40G，214 = C’ ≈ (C –C0) * (1-α) *  V’/Va  = （3888 - 976）* （1-α）* 40/ 100
            * 对于虚拟机Test_60G，323= C’ ≈ (C –C0) * (1-α) *  V’/Va  = （3888 - 976）* （1-α）*60/ 100 ，推算得到α= 0.816

            * 对于虚拟机Test_40G、Test_80G与Host的并发测试，
            * C = 3888， C0 =976，V=246G， Va=120G，代入上面推出的损耗率α= 0.816 ，有：
                * 对于虚拟机Test_40G，186 = C’ ≈ (C –C0) * (1-α) *  V’/Va  = （3888 - 976）* （1-α）* 40/ 120 = 178.6
                * 对于虚拟机Test_80G，362= C’ ≈ (C –C0) * (1-α) *  V’/Va  = （3888 - 976）* （1-α）* 80/ 120 = 357.2


            * 顺序写，C = 156， C0 =53，V=246G， Va=100G，
            * 对于虚拟机Test_40G，38 = C’ ≈ (C –C0) * (1-α) *  V’/Va  = （156 - 53）* （1-α）* 40/ 100
            * 对于虚拟机Test_60G，51= C’ ≈ (C –C0) * (1-α) *  V’/Va  = （156 - 53）* （1-α）*60/ 100 ，推算得到α= 0.126

            * 对于虚拟机Test_40G、Test_80G与Host的并发测试，
            * C = 156， C0 =52，V=246G， Va=120G，代入上面推出的损耗率α= 0.126，有：
                * 对于虚拟机Test_40G，33 = C’ ≈ (C –C0) * (1-α) *  V’/Va  = （156 - 52）* （1-α）* 40/ 120 =30.3
                * 对于虚拟机Test_80G，57= C’ ≈ (C –C0) * (1-α) *  V’/Va  = （156 - 52）* （1-α）* 80/ 120 = 60.6

    * 通过上节中的推导计算及验证，可知：

        * 同等并发情况下（相同数量的虚拟机与宿主机一起并发I/O），虚拟化的I/O损耗率一致，也即可以通过测试得出某种并发情况下的虚拟化I/O损耗率，然后根据计算公式推导出同等并发情况下某种规格虚拟机的I/O能力。

